{% extends "base.html" %}
{% block title %}Search Results ‚Ä¢ {{ keyword }}{% endblock %}
{% block content %}
<div class="header">
  <div class="logo"> Search Results</div>
  <div class="tagline">Keyword: {{ keyword }}</div>
  <div class="mt-4">
      <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê New Search</a>
  </div>
</div>
<div class="card">
  <div class="card-title">Summary</div>
  <div class="chip">Found <strong style="margin-left:6px">{{ total }}</strong> alive link{{ total|pluralize }}</div>
</div>
{% if links %}
<div class="table mt-4">
  <h3>Alive Links</h3>
  <table>
    <thead><tr><th>URL</th><th>Title</th><th>Status</th><th>Response</th><th>Action</th><th>Checked</th></tr></thead>
    <tbody>
      {% for link in links %}
      <tr>
        <td class="url">{{ link.url }}</td>
        <td>{{ link.title|default:"‚Äî" }}</td>
        <td><span class="badge badge-success">{{ link.status_code }}</span></td>
        <td>{% if link.response_time %}{{ link.response_time|floatformat:2 }}s{% else %}‚Äî{% endif %}</td>
        <td>
          <button class="btn btn-primary" style="padding:6px 12px" onclick="openSandbox({{ link.id }})">Open</button>
          <a class="btn btn-secondary" style="padding:6px 12px" href="{% url 'investigate_link' link.id %}">Investigate</a>
        </td>
        <td>{% if link.last_checked %}{{ link.last_checked|timesince }} ago{% else %}‚Äî{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="card mt-4"><div class="text-muted">No alive links found.</div></div>
{% endif %}
<div class="footer">Connected via Tor ‚Ä¢ Stay anonymous ‚Ä¢ Use VPN</div>
<div id="sandboxModal" class="modal">
  <div class="modal-content" style="max-width:1400px;height:90vh;margin:2% auto;display:flex;flex-direction:column">
    <div class="modal-header"><div class="modal-title">üîí Secure Sandbox</div><span class="close" onclick="closeSandbox()">√ó</span></div>
    <div style="flex:1;position:relative;background:#000">
      <div id="sandboxLoading" style="height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text-secondary)">
        <div class="loader"></div>
        <div style="color:var(--primary);font-weight:700">Loading content through Tor‚Ä¶</div>
        <div>This may take 20‚Äì30 seconds.</div>
      </div>
      <div id="sandboxError" style="display:none;height:100%;align-items:center;justify-content:center;text-align:center;color:#fca5a5;padding:22px">
        <div><div style="color:var(--error);font-weight:700;margin-bottom:10px">Failed to load content</div><div id="errorMessage"></div></div>
      </div>
      <iframe id="sandboxFrame" sandbox="allow-scripts allow-same-origin" style="display:none;width:100%;height:100%;border:none"></iframe>
    </div>
  </div>
</div>
<script>
function openSandbox(linkId){const modal=document.getElementById('sandboxModal');const loading=document.getElementById('sandboxLoading');const error=document.getElementById('sandboxError');const frame=document.getElementById('sandboxFrame');modal.style.display='block';loading.style.display='flex';error.style.display='none';frame.style.display='none';fetch(`/sandbox/${linkId}/`).then(resp=>resp.json()).then(data=>{loading.style.display='none';if(data.success){frame.style.display='block';frame.srcdoc=data.content}else{error.style.display='flex';document.getElementById('errorMessage').textContent=data.error||'Unknown error'}}).catch(err=>{loading.style.display='none';error.style.display='flex';document.getElementById('errorMessage').textContent='Network error: '+err.message})}
function closeSandbox(){const modal=document.getElementById('sandboxModal');const frame=document.getElementById('sandboxFrame');modal.style.display='none';frame.srcdoc=''}
window.addEventListener('click',ev=>{const m=document.getElementById('sandboxModal');if(ev.target===m)closeSandbox()});
</script>
{% endblock %}
